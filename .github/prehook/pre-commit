#!/bin/bash
#
# Copyright (c) 2025 A Bit of Help, Inc.
#

# Save this as .git/hooks/pre-commit (make it executable with chmod +x)

# Set file size limit (in bytes): 2MB =  2,097,152 bytes
MAX_SIZE=2097152
MAX_SIZE_MB=$((MAX_SIZE / 1024 / 1024))

echo "üîç Checking for large files (limit: ${MAX_SIZE_MB}MB)..."

# Check staged files
large_files_found=false

# Get list of staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$staged_files" ]; then
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            if [ $file_size -gt $MAX_SIZE ]; then
                file_size_mb=$((file_size / 1024 / 1024))
                echo "‚ùå ERROR: $file is ${file_size_mb}MB (exceeds ${MAX_SIZE_MB}MB limit)"
                large_files_found=true
            fi
        fi
    done <<< "$staged_files"
fi

if [ "$large_files_found" = true ]; then
    echo ""
    echo "üö´ Commit blocked: Large files detected!"
    echo "   Please remove large files or use Git LFS:"
    echo "   git lfs track '*.zip' && git add .gitattributes"
    echo "   Or remove the files: git rm <filename>"
    exit 1
else
    echo "‚úÖ No large files detected. Proceeding with commit."
fi